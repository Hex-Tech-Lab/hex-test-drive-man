# Development Workflow for Agents

## ⚠️ Critical Rule: Work Only from GitHub Remote

**NEVER assume code exists locally.** Agents operate in isolated containers. Always:
1. `git fetch origin` before starting work
2. `git checkout -b feature/my-feature origin/main` to branch from remote
3. Push frequently: `git push origin feature/my-feature`

## Branch Strategy

### Protected Branches
- `main`: Production-ready code. All PRs target this branch.
- Requires: CodeRabbit + Sourcery approval, passing build, no conflicts

### Feature Branches
- **Naming**: `feature/descriptive-name` (e.g., `feature/booking-system`)
- **Lifetime**: Delete after merge to main
- **Source**: Always branch from `origin/main`, never from another feature branch

### Agent Session Branches
- **Naming**: `claude/*`, `gemini/*` (auto-generated by agents)
- **Purpose**: Temporary work in progress
- **Cleanup**: Merge to feature branch, then delete session branch
- **Rule**: Never open PRs directly from session branches to main

## Pull Request Workflow

### Creating PRs
```
# 1. Branch from main
git checkout -b feature/my-feature origin/main

# 2. Make changes, commit frequently
git add .
git commit -m "feat: descriptive message"

# 3. Push to remote
git push origin feature/my-feature

# 4. Open PR to main
gh pr create --base main --head feature/my-feature \
  --title "feat: short title" \
  --body "Description with context"
```

### PR Requirements
- **Base branch**: Always `main`
- **Build status**: `pnpm build` must pass
- **AI reviews**: Tag ` @coderabbitai @sourcery-ai` in PR body
- **No conflicts**: Merge `origin/main` before requesting review

### After Merge
```
# Delete remote branch (automatic if configured in repo settings)
git push origin --delete feature/my-feature

# Delete local branch
git branch -d feature/my-feature
```

## Agent-Specific Guidelines

### For CCW (Next.js/TypeScript)
- Run `pnpm build` before every commit
- Use ` @/` path aliases (never `../`)
- Verify TypeScript with `npx tsc --noEmit`

### For CC (Python/Extraction)
- Work in `extraction_engine/` directory
- Document external dependencies in `requirements.txt`
- Never hardcode API keys (use `.env.local`)

### For GC (Repo Management)
- Audit branches weekly: `git branch -r | grep 'claude/'`
- Close stale PRs > 14 days with no activity
- Update `docs/REPOSITORY_STATE.md` after major merges

## Conflict Resolution

### When Merge Conflicts Occur
```
# 1. Fetch latest main
git fetch origin main

# 2. Merge main into your feature branch
git checkout feature/my-feature
git merge origin/main

# 3. Resolve conflicts in editor
# 4. Mark resolved
git add <conflicted-files>
git commit -m "chore: resolve merge conflicts with main"

# 5. Push
git push origin feature/my-feature
```

### Common Conflicts
- `pnpm-lock.yaml`: Accept incoming (main) version, then `pnpm install`
- `package.json`: Carefully merge dependencies, prefer main's versions
- TypeScript files: Preserve both changes if additive, test build

## Documentation

### Required Docs for New Features
- Update `CLAUDE.md` or `GEMINI.md` with session context
- Add entry to `DOCS_INDEX.md`
- Update `MVP_ROADMAP.md` if milestone affected

### Commit Message Format
```
type(scope): short description

Longer explanation if needed.

- Bullet point details
- Related changes
```

Types: `feat`, `fix`, `chore`, `docs`, `refactor`, `test`

## Emergency Rollback

If `main` breaks after merge:
```
# 1. Find last good commit
git log --oneline origin/main -10

# 2. Reset to that commit
git checkout main
git reset --hard <good-commit-sha>

# 3. Force push (use with caution)
git push origin main --force-with-lease

# 4. Notify team and reopen PR with fixes
```

## Questions?
Refer to `AGENTS.md` for agent capabilities or ping @TechHypeXP in PR comments.
